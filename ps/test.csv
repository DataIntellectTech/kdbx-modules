action,ms,bytes,lang,code,repeat,minver,comment
comment,,,,,,,Setup for server and client testing
comment,,,,,,,Replace $QHOME (defaults to $HOME) to avoid hard-coding
beforeany,0,0,q,system "QHOME=${QHOME:-$HOME}; q ${QHOME}/kdbx-packages/ps/ps.q -p 5010 -q &",1,,start server in background
beforeany,0,0,q,system "sleep 1",1,,wait for server to initialize
beforeany,0,0,q,h:hopen `::5010,1,,open handle h on client for testing
true,0,0,q,h>0,1,,verify client connected to server
beforeany,0,0,q,h "trade:([]time:\"p\"$();`g#sym:`$();price:\"f\"$();tsize:\"i\"$());",1,,define trade table on server
beforeany,0,0,q,h "quote:([]time:\"p\"$();`g#sym:`$();bid:\"f\"$();bidsize:\"f\"$();ask:\"f\"$();asksize:\"f\"$());",1,,define quote table on server
run,0,0,q,h ".ps.init[]",1,,initialize server state
true,0,0,q,1b~h ".ps.initialized",1,,confirm server initialized with necessary data
run,0,0,q,clt:first h "key[.z.W]",1,,get client handle on server

run,0,0,q,res:h (`.ps.suball;`quote),1,,test subscribe to quote for all symbols
true,0,0,q,clt in h ".ps.reqalldict[`quote]",1,,client is subscribed
true,0,0,q,`quote~res[0] 0,1,,client receives subscribed table confirmation
true,0,0,q,98h~type res[1] 0,1,,client receives table schema

run,0,0,q,res:h (`.ps.add;`trade),1,,test adding handle to trade table
true,0,0,q,clt in h ".ps.reqalldict[`trade]",1,,client handle is added 

run,0,0,q,res:h (`.ps.subscribe;`;`),1,,test subscribe to all tables without filtering
true,0,0,q,clt in h ".ps.reqalldict[`trade]",1,,client handle is added 
true,0,0,q,clt in h ".ps.reqalldict[`quote]",1,,client handle is added 
true,0,0,q,98h~type res[1] 0,1,,client receives table schema
true,0,0,q,98h~type res[1] 1,1,,client receives table schema

run,0,0,q,res:h (`.ps.subfiltered;`trade`quote;`ibm`nvo),1,,test subscribe to specified tables with list of symbols
true,0,0,q,`trade`quote~res[0],1,,client receives subscribed table confirmation
true,0,0,q,98h~type res[1] 0,1,,client receives table schema
true,0,0,q,98h~type res[1] 1,1,,client receives table schema
run,0,0,q,res:h "select from .ps.reqfilteredtbl where table in `trade`quote",1,,check filtered table for the subscription
run,0,0,q,res:select from res where handle=clt,1,,check filtered table for the subscription
true,0,0,q,res[`filts][0]~enlist enlist (in;`sym;enlist `ibm`nvo),1,, test symbols are listed under filters

run,0,0,q,hclose h,1,,test closesub function handles are removed after connection close
run,0,0,q,h:hopen `::5010,1,,open handle h on client for testing
run,0,0,q,clt:first h "key[.z.W]",1,,get client handle on server
true,0,0,q,(`$())~ h "key[.ps.reqalldict]",1,,handle not in reqalldict since previous handle removed and new subscription not made
true,0,0,q,not clt in (h ".ps.reqfilteredtbl")`handle,1,,handle not in reqfilteredtbl

run,0,0,q,res:h (`.ps.subscribe;`;`AAPL`GOOG),1,,test subscribe to all tables with specified symbols
true,0,0,q,`quote`trade~res[0],1,,client receives subscribed table confirmation
true,0,0,q,98h~type res[1] 0,1,,client receives table schema
true,0,0,q,98h~type res[1] 1,1,,client receives table schema
run,0,0,q,res:h "select from .ps.reqfilteredtbl where table in `trade`quote",1,,check filtered table for the subscription
run,0,0,q,res:select from res where handle=clt,1,,check filtered table for the subscription
true,0,0,q,res[`filts][0]~enlist enlist (in;`sym;enlist `AAPL`GOOG),1,, test symbols are listed under filters

run,0,0,q,res:h (`.ps.subscribe;`trade`dummy;`AAPL`GOOG),1,,test subscribe with incorrect table name
true,0,0,q,(`$"dummy not available for subscription")~res[0],1,,client receives error message for the incorrect table name
true,0,0,q,`trade~first res[1;0],1,,client receives subscribed table confirmation
true,0,0,q,98h~type res[1;1] 1,1,,client receives table schema
run,0,0,q,res:h "select from .ps.reqfilteredtbl where table in `trade",1,,check filtered table for the subscription
run,0,0,q,res:select from res where handle=clt,1,,check filtered table for the subscription
true,0,0,q,res[`filts][0]~enlist enlist (in;`sym;enlist `AAPL`GOOG),1,, test symbols are listed under filters

run,0,0,q,"conditions:([tabname:`trade`quote] filts:("""";""bid>100,bid<200""); columns:(""time,sym,price"";""""))",1,,create custom conditions for subscription
run,0,0,q,res:h (`.ps.subscribe;`;conditions),1,,test subscribe with custom conditions
true,0,0,q,`trade`quote~res[0],1,,client receives subscribed table confirmation
true,0,0,q,98h~type res[1] 0,1,,client receives table schema
true,0,0,q,98h~type res[1] 1,1,,client receives table schema
run,0,0,q,res:h "select from .ps.reqfilteredtbl where table in `trade`quote",1,,check filtered table for the subscription
run,0,0,q,res:select from res where handle=clt,1,,check filtered table for the subscription
true,0,0,q,(enlist `time`sym`price!`time`sym`price)~(select from res where table=`trade)`columns,1,, test symbols are listed under filters
true,0,0,q,(enlist enlist ((>;`bid;100);(<;`bid;200)))~(select from res where table=`quote)`filts,1,, test constraints listed under filters

true,0,0,q,clt~first h (`.ps.getallhandles`),1,,test getallhandles function,one client handle only in the case

run,0,0,q,"res:h (`.ps.substr;""trade"";""GOOG,AAPL"")",1,,test subscribe with strings
true,0,0,q,`trade~first res[0],1,,client receives subscribed table confirmation
true,0,0,q,98h~type first res[1],1,,client receives table schema
run,0,0,q,res:h "select from .ps.reqfilteredtbl where table=`trade",1,,check filtered table for the subscription
run,0,0,q,res:select from res where handle=clt,1,,check filtered table for the subscription
true,0,0,q,res[`filts][0]~enlist enlist (in;`sym;enlist `GOOG`AAPL),1,, test symbols are listed under filters

run,0,0,q,"res:h (`.ps.substrf;""quote"";""bid>50.0"";""time,sym,bid"")",1,,test subscribe with strings
true,0,0,q,`quote~first res[0],1,,client receives subscribed table confirmation
true,0,0,q,98h~type first res[1],1,,client receives table schema
run,0,0,q,res:h "select from .ps.reqfilteredtbl where table=`quote",1,,check filtered table for the subscription
run,0,0,q,res:select from res where handle=clt,1,,check filtered table for the subscription
true,0,0,q,res[`filts][0]~enlist enlist (>;`bid;50f),1,, test symbols are listed under filters


