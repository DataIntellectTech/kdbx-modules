run,0,0,q,dataloader:use`di.dataloader,1,,Load in dataloader module
run,0,0,q,os:use`di.os,1,,Load in os module for system commands
run,0,0,q,os.cd hsym first`$system"echo $HOME/kdbx-modules/di/dataloader",1,,Cd to dataloader directory
run,0,0,q,{if[os.isdir x;os.deldir x]}`:test,1,,Delete test directory if it already existed
run,0,0,q,os.mkdir each`:test/data/hdb`:test/data/files`:test/data/symdir,1,,Create hdb/files/enum directory
run,0,0,q,hdbpath:hsym`$os.abspath`:test/data/hdb,,1,,Hardcode hdb path
run,0,0,q,filespath:hsym`$os.abspath`:test/data/files,,1,,Hardcode files path
run,0,0,q,symdirpath:hsym`$os.abspath`:test/data/symdir,,1,,Hardcode enum files path

run,0,0,q,tradetab:([]time:asc 2024.01.15D09:30+10?00:10:00;sym:10?`AAPL`GOOGL`MSFT`TSLA`NVDA`AMD;price:(5*10?10000)%100;size:5*10?100;side:10?`B`S;exchange:10?`NYSE`NASDAQ),1,,Create mock trade table
run,0,0,q,quotetab:([]time:asc 2024.01.15D09:30+10?00:10:00;sym:10?`AAPL`GOOGL`MSFT`TSLA`NVDA`AMD;bid:(5*10?10000)%100;ask:(5*10?10000)%100;bsize:5*10?100;asize:5*10?100;exchange:10?`NYSE`NASDAQ),1,,Create mock quote table
run,0,0,q,"tradedailytab:([]date:asc 2024.02.01,2024.01.15+9?10;time:{x+10?x}09:00:00.000;sym:10?`AAPL`GOOGL`MSFT`TSLA`NVDA`AMD;price:(5*10?10000)%100;size:5*10?100;exchange:10?`NYSE`NASDAQ)",1,,Create mock tradedaily table

run,0,0,q,"(` sv filespath,`tradenh.csv)0:1_csv 0:tradetab",1,,Save trade csv without headers
run,0,0,q,"(` sv filespath,`trade.csv)0:csv 0:tradetab",1,,Save trade csv with headers
run,0,0,q,"(` sv filespath,`tradedaily.csv)0:csv 0:tradedailytab",1,,Save tradedaily csv
run,0,0,q,"(` sv filespath,`quotenh.csv)0:1_csv 0:quotetab",1,,Save quote csv without headers
run,0,0,q,"(` sv filespath,`quote.csv)0:csv 0:quotetab",1,,Save quote csv with headers

run,0,0,q,dataloader.addsortparams[`quote`tradedaily;`s`;`time`;10b],1,,Add custom sort parameters

run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`filepattern!(`time`sym`price`size`side`exchange;"PSFISS";csv;`trade;hdbpath;"tradenh.csv");filespath],1,,Test load of trade file with no headers
run,0,0,q,\l test/data/hdb,1,,Load database 
true,0,0,q,`trade in tables[],1,,Test table loaded to db
true,0,0,q,`p=meta[trade][`sym;`a],1,,Check sym column is parted
true,0,0,q,`2024.01.15 in key`:.,1,,Check table saved to correct partition
true,0,0,q,`sym in key `:.,1,,Check sym file created and enumerated against

run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`filepattern!(`time`sym`price`size`side`exchange;"PSFISS";1#csv;`trade;hdbpath;"trade.csv");filespath],1,,Test load of trade file with headers
run,0,0,q,\l .,1,,Reload database 
true,0,0,q,`trade in tables[],1,,Test table loaded to db
true,0,0,q,`p=meta[trade][`sym;`a],1,,Check sym column is parted
true,0,0,q,`2024.01.15 in key`:.,1,,Check table saved to correct partition
true,0,0,q,`sym in key `:.,1,,Check sym file created and enumerated against

run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`symdir`filepattern!(`time`sym`price`size`side`exchange;"PSFISS";1#csv;`trade;hdbpath;symdirpath;"trade.csv");filespath],1,,Test load of trade file with specfied symdir
run,0,0,q,\l .,1,,Reload database
true,0,0,q,`trade in tables[],1,,Test table loaded to db
true,0,0,q,os.exists`:../symdir,1,,Test sym file enumerated to custom directory

run,0,0,q,os.del`:sym,1,,Remove sym
run,0,0,q,os.deldir`:2024.01.15,1,,Remove partition to avoid errors
run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`enumname`filepattern!(`time`sym`price`size`side`exchange;"PSFISS";1#csv;`trade;hdbpath;`mocksym;"trade.csv");filespath],1,,Test load of trade file with specfied symfile name
run,0,0,q,\l .,1,,Reload database
true,0,0,q,`mocksym in key`:.,1,,Check that db sym file has custom name

run,0,0,q,os.del`:mocksym,1,,Remove mocksym
run,0,0,q,os.deldir`:2024.01.15,1,,Remove partition to avoid errors
run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`partitiontype`partitioncol`filepattern!(`date`time`sym`price`size`exchange;"DTSFIS";1#csv;`tradedaily;hdbpath;`month;`date;"tradedaily.csv");filespath],1,,Test custom partition overwrites
run,0,0,q,\l .,1,,Reload database
true,0,0,q,all`2024.01`2024.02 in key`:.,1,,Check partitions were created as month and all are there
true,0,0,q,all null exec a from 0!meta tradedaily,1,,Check no attributes applied to tradedaily table
run,0,0,q,os.deldir each`:2024.01`:2024.02,1,,Remove month partitions

run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`chunksize`filepattern!(`time`sym`bid`ask`bsize`asize`exchange;"PSFFIIS";csv;`quote;hdbpath;200i;"quotenh.csv");filespath],1,,Test load of quote file
run,0,0,q,\l .,1,,reload database
true,0,0,q,`quote in tables[],1,,Test quote table loaded to db in chunks
true,0,0,q,10=count quote,1,,Test all of quote file loaded in chunks

run,0,0,q,os.deldir`:2024.01.15,1,,Delete directory to handle new column
run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`dataprocessfunc`filepattern!(`time`sym`bid`ask`bsize`asize`exchange;"PSFFIIS";1#csv;`quote;hdbpath;{[loaderparams;data]update mid:avg(bid;ask)from data};"quote.csv");filespath],1,,Test load of quote file
run,0,0,q,\l .,1,,Reload database
true,0,0,q,`quote in tables[],1,,Check that table loaded to db
true,0,0,q,`mid in cols quote,1,,Check that column from update function is included in save down

run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`compression`filepattern!(`time`sym`price`size`side`exchange;"PSFISS";1#csv;`trade;hdbpath;(17i;2i;6i);"trade.csv");filespath],1,,Test loading with compression specified
run,0,0,q,\l .,1,,Reload database
true,0,0,q,`trade in tables[],1,,Test trade table loaded to db
true,0,0,q,(2i;17i;6i)~(-21!`:2024.01.15/trade/exchange)[`algorithm`logicalBlockSize`zipLevel],1,,Check compression for exchange column
true,0,0,q,(2i;17i;6i)~(-21!`:2024.01.15/trade/price)[`algorithm`logicalBlockSize`zipLevel],1,,Check compression for price column
true,0,0,q,(2i;17i;6i)~(-21!`:2024.01.15/trade/side)[`algorithm`logicalBlockSize`zipLevel],1,,Check compression for side column
true,0,0,q,(2i;17i;6i)~(-21!`:2024.01.15/trade/size)[`algorithm`logicalBlockSize`zipLevel],1,,Check compression for size column
true,0,0,q,(2i;17i;6i)~(-21!`:2024.01.15/trade/sym)[`algorithm`logicalBlockSize`zipLevel],1,,Check compression for sym column
true,0,0,q,(2i;17i;6i)~(-21!`:2024.01.15/trade/time)[`algorithm`logicalBlockSize`zipLevel],1,,Check compression for time column

run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`gc`filepattern!(`time`sym`price`size`side`exchange;"PSFISS";1#csv;`trade;hdbpath;1b;"trade.csv");filespath],1,,Test loading with garbage collection enabled
run,0,0,q,\l .,1,,Reload database
true,0,0,q,`trade in tables[],1,,Test trade table loaded to db

run,0,0,q,os.deldir`:2024.01.15,1,,Remove partition to avoid errors
run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`filepattern!(`time`sym`price`size`side`exchange;"PSFISS";1#csv;`trade;hdbpath;"trade.csv");filespath],1,,Test load of trade file
run,0,0,q,dataloader.loadallfiles[`headers`types`separator`tablename`dbdir`filepattern!(`time`sym`bid`ask`bsize`asize`exchange;"PSFFIIS";1#csv;`quote;hdbpath;"quote.csv");filespath],1,,Test load of quote file
run,0,0,q,\l .,1,,Reload database
true,0,0,q,`s=meta[quote][`time;`a],1,,Check quote table sorted on time
true,0,0,q,`trade in tables[],1,,Test trade table loaded to db
true,0,0,q,`quote in tables[],1,,Test quote table loaded to db

run,0,0,q,os.cd hsym first`$system"echo $HOME/kdbx-modules/di/dataloader",1,,Cd to dataloader directory
run,0,0,q,os.deldir`:test/,1,,Delete the test directory
