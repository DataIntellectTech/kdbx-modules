action,ms,bytes,lang,code,repeat,minver,comment

before,0,0,q,usage:use`usage,1,,Initialize package

run,0,0,q,usage.init[],1,1,out-of-the-box configuration
run,0,0,q,.testusg.runhandler[`.z.pw;(`test_user;"pass123")],1,1,
run,0,0,q,.testusg.runhandler[`.z.po;1i],1,1,
run,0,0,q,.testusg.runhandler[`.z.pc;2i],1,1,
run,0,0,q,.testusg.runhandler[`.z.wo;3i],1,1,
run,0,0,q,.testusg.runhandler[`.z.wc;4i],1,1,
run,0,0,q,.testusg.runhandler[`.z.ws;-8!"1+1"],1,1,
run,0,0,q,.testusg.runhandler[`.z.pg;"1+1"],1,1,
run,0,0,q,.testusg.runhandler[`.z.ps;(+;2;2)],1,1,
run,0,0,q,.testusg.runhandler[`.z.ph;(.j.j`x`y`z!(1;"http%3a%2f%2fdomain.com";`get);`hdr1`hdr2!("hello";"goodbye"))],1,1,
run,0,0,q,.testusg.runhandler[`.z.pp;(.j.j`x`y`z!(1;"http%3a%2f%2fdomain.com";`post);`hdr1`hdr2!("hello";"goodbye"))],1,1,
run,0,0,q,.testusg.runhandler[`.z.exit;0],1,1,
true,0,0,q,.testusg.chkusage[],1,1,
run,0,0,q,.testusg.reset[],1,1,

run,0,0,q,.testusg.setcustomhandlers[],1,1,run with custom handlers and verify that they are properly invoked
run,0,0,q,usage.init[],1,1,
run,0,0,q,.testusg.runhandler[`.z.pw;(`test_user;"pass123")],1,1,
run,0,0,q,.testusg.runhandler[`.z.po;1i],1,1,
run,0,0,q,.testusg.runhandler[`.z.pc;2i],1,1,
run,0,0,q,.testusg.runhandler[`.z.wo;3i],1,1,
run,0,0,q,.testusg.runhandler[`.z.wc;4i],1,1,
run,0,0,q,.testusg.runhandler[`.z.ws;-8!"1+1"],1,1,
run,0,0,q,.testusg.runhandler[`.z.pg;"1+1"],1,1,
run,0,0,q,.testusg.runhandler[`.z.ps;(+;2;2)],1,1,
run,0,0,q,.testusg.runhandler[`.z.ph;"dummy"],1,1,
run,0,0,q,.testusg.runhandler[`.z.pp;"dummy"],1,1,
run,0,0,q,.testusg.runhandler[`.z.exit;255],1,1,
true,0,0,q,.testusg.chkusage[],1,1,
true,0,0,q,([]zcmd:`.z.pw`.z.po`.z.pc`.z.wo`.z.wc`.z.ws`.z.pg`.z.ps`.z.ph`.z.pp`.z.exit;args:((`test_user;"pass123");1i;2i;3i;4i;-8!"1+1";"1+1";(+;2;2);"dummy";"dummy";255))~1_.testusg.customtracker,1,1,
run,0,0,q,.testusg.reset[],1,1,

run,0,0,q,.test.mock[`.m.usage.logtodisk;1b],1,1,should error on invalid logging configurations
true,0,0,q,@[usage.init;::;::]~"logname and logdir must be set to enable on disk usage logging. .usage.logToDisk disabled",1,1,
run,0,0,q,.test.mock'[`.m.usage.logtodisk`.m.usage.logdir`.m.usage.logname;(1b;".";"")],1,1,
true,0,0,q,@[usage.init;::;::]~"logname and logdir must be set to enable on disk usage logging. .usage.logToDisk disabled",1,1,
run,0,0,q,.test.mock'[`.m.usage.logtodisk`.m.usage.logdir`.m.usage.logname;(1b;"";"test")],1,1,
true,0,0,q,@[usage.init;::;::]~"logname and logdir must be set to enable on disk usage logging. .usage.logToDisk disabled",1,1,

run,0,0,q,.test.mock[`.m.usage.createlog;{z;'"some error"}],1,1,should fail if log file creation errors
run,0,0,q,.test.mock'[`.m.usage.logtodisk`.m.usage.logdir`.m.usage.logname;(1b;".";"test")],1,1,
true,0,0,q,@[usage.init;::;::]like"Error creating log file: ./usage_test_* | Error: some error",1,1,
run,0,0,q,.test.unmock[],1,1,
run,0,0,q,.testusg.reset[],1,1,

run,0,0,q,.test.mock'[`.m.usage.logtodisk`.m.usage.logdir`.m.usage.logname;(1b;".";"test")],1,1,should correctly write to and read from log file
run,0,0,q,@[system;"rm usage_test_* 2> /dev/null";::];,1,1,clean up in case of previous run
run,0,0,q,usage.init[],1,1,
run,0,0,q,.testusg.runhandler[`.z.po;1i],1,1,
run,0,0,q,.testusg.runhandler[`.z.pg;"1+1"],1,1,
run,0,0,q,.testusg.runhandler[`.z.pg;(avg;1 2 3)],1,1,
run,0,0,q,.testusg.runhandler[`.z.pc;1i],1,1,
true,0,0,q,.testusg.chkusage usage.readlog first system"ls usage_test_*",1,1,
run,0,0,q,.testusg.reset[],1,1,
run,0,0,q,.test.unmock[],1,1,
run,0,0,q,system"rm usage_test_*",1,1,

run,0,0,q,usage.init[],1,1,log at different levels
run,0,0,q,.test.mock[`.m.usage.level;0],1,1,log nothing
run,0,0,q,.z.po 1i,1,1,
run,0,0,q,.z.pg"1+1",1,1,
fail,0,0,q,.z.pg"1+`a",1,1,
run,0,0,q,.z.pc 1i,1,1,
true,0,0,q,0=count usage.getusage[],1,1,
run,0,0,q,.test.mock[`.m.usage.level;1],1,1,log errors only
run,0,0,q,.z.po 1i,1,1,
run,0,0,q,.z.pg"1+1",1,1,
fail,0,0,q,.z.pg"1+`a",1,1,
run,0,0,q,.z.pc 1i,1,1,
true,0,0,q,(1=count usage.getusage[])&usage.getusage[][0;`zcmd`status`cmd`error]~(`pg;"e";"1+`a";"type"),1,1,
run,0,0,q,.m.usage.usage:0#usage.getusage[],1,1,
run,0,0,q,.test.mock[`.m.usage.level;2],1,1,log open/close/queries (no "before" queries)
run,0,0,q,.z.ps"1+1",1,1,
run,0,0,q,(1=count usage.getusage[])&usage.getusage[][0;`zcmd`status`cmd]~(`ps;"c";"1+1"),1,1,
run,0,0,q,.m.usage.usage:0#usage.getusage[],1,1,
run,0,0,q,.test.unmock[],1,1,restore default level

run,0,0,q,.test.mock'[`.m.usage.ignore`.m.usage.ignorelist;(1b;(`upd;"0+0"))],1,1,
run,0,0,q,.test.mock[;{y;}]each`upd`fn,1,1,
run,0,0,q,.z.ps(+;1;2),1,1,not ignored
run,0,0,q,.z.ps(`upd;`trade;([]x:1 2)),1,1,ignored
run,0,0,q,.z.ps(`fn;`trade;([]x:1 2)),1,1,not ignored
run,0,0,q,.z.ps"0+0",1,1,ignored
run,0,0,q,.z.ps"1+0",1,1,not ignored
true,0,0,q,([]zcmd:`ps;status:6#"bc";cmd:(.Q.s1(+;1;2);.Q.s1(`fn;`trade;([]x:1 2));"1+0")where 3#2)~`zcmd`status`cmd#usage.getusage[],1,1,
run,0,0,q,.getusage[]:0#usage.getusage[],1,1,
run,0,0,q,.test.unmock[],1,1,

run,0,0,q,".test.mock[`m.usage.ext;{.testusg.ext,:enlist x}]",1,1,test extension
run,0,0,q,.z.pw[`test_user;"pass123"],1,1,
run,0,0,q,.z.po 1i,1,1,
run,0,0,q,.z.pc 2i,1,1,
run,0,0,q,.z.wo 3i,1,1,
run,0,0,q,.z.wc 4i,1,1,
run,0,0,q,.test.mock[`.z.ps;{}],1,1,
run,0,0,q,.z.ws -8!"1+1",1,1,
run,0,0,q,.test.unmock`.z.ps,1,1,
run,0,0,q,.z.pg"1+1",1,1,
run,0,0,q,.z.ps(+;2;2),1,1,
run,0,0,q,.z.ph(.j.j`x`y`z!(1;"http%3a%2f%2fdomain.com";`get);`hdr1`hdr2!("hello";"goodbye")),1,1,
run,0,0,q,.z.pp(.j.j`x`y`z!(1;"http%3a%2f%2fdomain.com";`post);`hdr1`hdr2!("hello";"goodbye")),1,1,
run,0,0,q,.z.exit 0,1,1,
true,0,0,q,usage.getusage[]~flip key[flip usage.getusage[]]!flip .testusg.ext,1,1,
run,0,0,q,.m.usage.usage:0#usage.getusage[],1,1,
run,0,0,q,.test.unmock[],1,1,

run,0,0,q,.test.mock[`.m.usage.usage;([]id:1 1 2 2 3;time:2025.07.24+0D12 0D12:00:00.1 0D12:01:59.999999999 0D12:02 0D12:05)],1,1,
run,0,0,q,.test.mock[`.m.usage.currenttime;{2025.07.24D12:07}]
run,0,0,q,usage.flushusage 0D00:05,1,1,
true,0,0,q,usage.getusage[]~([]id:2 3;time:2025.07.24+0D12:02 0D12:05),1,1,
run,0,0,q,usage.flushusage 5D,1,1,nop
true,0,0,q,usage.getusage[]~([]id:2 3;time:2025.07.24+0D12:02 0D12:05),1,1,
run,0,0,q,usage.flushusage 0,1,1,wipe
true,0,0,q,0=count usage.getusage[],1,1,
run,0,0,q,usage.flushusage 0D00:01,1,1,no effect on empty table
true,0,0,q,0=count usage.getusage[],1,1,
run,0,0,q,.test.unmock[],1,1,


